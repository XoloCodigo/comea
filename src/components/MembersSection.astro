---
/**
 * Componente: MembersSection
 *
 * Muestra la grilla de instituciones miembros de COMEA.
 *
 * INTEGRACIÓN CON WORDPRESS:
 * - Este contenido DEBE ser un Custom Post Type (CPT) llamado "Miembros" o "Instituciones".
 * - Campos sugeridos:
 *   - Nombre de la Institución
 *   - Logo (Imagen destacada)
 *   - Tipo (Pública, Privada) -> Taxonomía para los filtros.
 *   - Enlace al sitio web (opcional)
 */
import { Icon } from "astro-icon/components";

// Lista de Miembros extraída del PDF y consolidada
const members = [
  "UNAM",
  "IPN",
  "UNAQ",
  "UANL",
  "ITESM",
  "UACH",
  "UPB",
  "CETYS Universidad",
  "INADET",
  "Universidad Tecnológica de Tijuana",
  "CAB",
  "Universidad Politécnica de Chihuahua",
  "Conalep Querétaro",
  "UT Guaymas",
  "UT Hermosillo",
  "Universidad Politécnica Metropolitana de Hidalgo",
  "UTJ",
  "UPAEP",
  "CENALTEC",
  "Universidad Politécnica de Apodaca",
  "Tecnológico de Monterrey",
  "CDA",
  "UAZ",
  "UPIIG",
  "Universidad Marista de Guadalajara",
  "ITSON",
  "ESIME Ticomán",
  "Prepa Sanmiguelense",
  "Tecnológico Nacional de México",
  "Universidad Cuauhtémoc",
  "UACJ",
  "CECYT 17",
  "Universidad Politécnica de Aguascalientes",
  "Cluster Aeroespacial",
];
// Límite para mostrar en móvil por defecto
const MOBILE_LIMIT = 10;
const totalMembers = members.length;
---

<section id="miembros" class="py-20 max-w-7xl mx-auto px-6">
  <div class="flex flex-col md:flex-row justify-between items-center mb-12">
    <div>
      <h1 class="text-3xl font-bold text-comea-main dark:text-white">
        Instituciones Miembro
      </h1>
      <p class="text-slate-500 dark:text-slate-400">
        La red académica aeroespacial aeroespacial más grande de México.
      </p>
    </div>

    <!-- Filtros (Funcionalidad visual) -->
    <div class="mt-6 md:mt-0 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
      <button
        class="px-4 py-2 rounded-full bg-comea-main text-white text-sm font-medium transition-colors hover:bg-comea-light shadow-md whitespace-nowrap"
        >Todos</button
      >
      <button
        class="px-4 py-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-medium hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors whitespace-nowrap"
        >Públicas</button
      >
      <button
        class="px-4 py-2 rounded-full bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-medium hover:bg-slate-300 dark:hover:bg-slate-700 transition-colors whitespace-nowrap"
        >Privadas</button
      >
    </div>
  </div>

  <!-- Grid de Miembros Dinámico -->
  <div
    id="members-grid"
    class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"
  >
    {
      members.map((member, index) => (
        <div
          class={`
                    aspect-square glass-card rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col items-center justify-center p-4 
                    hover:shadow-lg hover:border-comea-tech transition-all group cursor-pointer bg-white dark:bg-dark-card
                    ${index >= MOBILE_LIMIT ? "hidden sm:flex" : "flex"} 
                `}
          data-index={index}
        >
          <div class="w-12 h-12 mb-3 text-slate-300 group-hover:text-comea-main dark:group-hover:text-comea-tech transition-colors flex items-center justify-center">
            <Icon name="fa6-solid:building-columns" class="text-4xl" />
          </div>
          <span class="text-xs font-bold text-center text-slate-600 dark:text-slate-300 line-clamp-3 leading-tight">
            {member}
          </span>
        </div>
      ))
    }
  </div>

  <!-- Botón "Mostrar Más" visible solo si hay más elementos que el límite y solo en móvil/tablet -->
  {
    totalMembers > MOBILE_LIMIT && (
      <div id="show-more-container" class="mt-10 text-center sm:hidden">
        <button
          id="show-more-btn"
          onclick="toggleMembersVisibility()"
          class="inline-flex items-center px-6 py-3 rounded-lg bg-comea-main text-white font-bold text-sm hover:bg-comea-light transition-colors shadow-lg shadow-blue-900/30"
        >
          <span id="show-more-text">
            Mostrar todas las {totalMembers} instituciones
          </span>
          <span
            id="show-more-icon"
            class="ml-3 transition-transform duration-300"
          >
            <Icon name="fa6-solid:chevron-down" />
          </span>
        </button>
      </div>
    )
  }

  <!-- Call to Action -->
  <div class="mt-16 text-center hidden sm:block">
    <p class="text-slate-500 mb-4">¿Tu institución aún no es parte de COMEA?</p>
    <a
      href="#contacto"
      class="inline-block px-6 py-3 rounded-lg border border-comea-main text-comea-main dark:border-comea-tech dark:text-comea-tech font-bold text-sm hover:bg-comea-main hover:text-white transition-colors"
    >
      Solicitar Afiliación
    </a>
  </div>
</section>

<script define:vars={{ totalMembers, MOBILE_LIMIT }} is:inline>
  // Ahora las variables totalMembers y MOBILE_LIMIT están disponibles aquí directamente

  // Lógica para alternar la visibilidad de las tarjetas en móvil
  window.toggleMembersVisibility = function () {
    const grid = document.getElementById("members-grid");
    const button = document.getElementById("show-more-btn");
    const textSpan = document.getElementById("show-more-text");
    const iconSpan = document.getElementById("show-more-icon");
    const section = document.getElementById("miembros"); // Obtenemos la sección completa

    if (!grid || !button || !section) return; // Evita errores si no encuentra los elementos

    // Obtener solo las tarjetas que deben ser ocultadas/mostradas
    const hiddenCards = Array.from(grid.children).filter((card) => {
      const index = parseInt(card.getAttribute("data-index"));
      // Filtramos las tarjetas que están más allá del límite
      return index >= MOBILE_LIMIT;
    });

    const isExpanded = button.getAttribute("data-expanded") === "true";

    if (isExpanded) {
      // OCULTAR
      if (window.innerWidth < 640) {
        hiddenCards.forEach((card) => (card.style.display = "none"));
      }
      if (textSpan)
        textSpan.innerText = `Mostrar todas las ${totalMembers} instituciones`;
      if (iconSpan) iconSpan.style.transform = "rotate(0deg)";
      button.setAttribute("data-expanded", "false");

      // SOLUCIÓN: Hacemos scroll suave al inicio de la sección después de ocultar
      section.scrollIntoView({ behavior: "smooth", block: "start" });
    } else {
      // MOSTRAR
      hiddenCards.forEach((card) => (card.style.display = "flex"));
      if (textSpan) textSpan.innerText = `Ocultar instituciones`;
      if (iconSpan) iconSpan.style.transform = "rotate(180deg)";
      button.setAttribute("data-expanded", "true");
    }
  };

  // Función para asegurar el estado inicial al cargar o al cambiar de tamaño
  function initializeMemberView() {
    const grid = document.getElementById("members-grid");
    const button = document.getElementById("show-more-btn");
    const showMoreContainer = document.getElementById("show-more-container");
    const textSpan = document.getElementById("show-more-text");
    const iconSpan = document.getElementById("show-more-icon");

    if (!grid || !showMoreContainer || !button) return;

    const isMobile = window.innerWidth < 640;

    // Ocultar las tarjetas si estamos en móvil
    Array.from(grid.children).forEach((card) => {
      const index = parseInt(card.getAttribute("data-index"));
      if (index >= MOBILE_LIMIT) {
        // En móvil, forzamos a ocultar las extras. En desktop, Tailwind las muestra vía 'sm:flex'.
        card.style.display = isMobile ? "none" : "flex";
      }
    });

    if (isMobile) {
      button.setAttribute("data-expanded", "false");
      if (textSpan)
        textSpan.innerText = `Mostrar todas las ${totalMembers} instituciones`;
      if (iconSpan) iconSpan.style.transform = "rotate(0deg)";
      showMoreContainer.classList.remove("hidden");
    } else {
      // En desktop, ocultamos el botón
      showMoreContainer.classList.add("hidden");
    }
  }

  // Ejecutar en carga inicial y al redimensionar
  document.addEventListener("DOMContentLoaded", initializeMemberView);
  window.addEventListener("resize", initializeMemberView);
</script>
